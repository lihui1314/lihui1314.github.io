---
layout: post
title: "iOSå®ç°åˆ›å»ºä¸€ä¸ªå…¨å±€é•¿é©»é˜Ÿåˆ—æ± "
---
YYKitçœŸæ˜¯ä¸€ä¸ªéå¸¸ä¼˜ç§€çš„æ¡†æ¶ï¼

æœ€è¿‘çœ‹YYLabelæºç ï¼Œçœ‹åˆ°å…¶ä¸­ä¸€æ®µä»£ç éå¸¸æœ‰æ„æ€ï¼Œä½œè€…åœ¨è¦display layerçš„å®ˆå€™è·å–ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ï¼ŒæŠŠç»˜åˆ¶ä»»åŠ¡æ”¾å…¥å…¶ä¸­å®Œæˆå¼‚æ­¥ç»˜åˆ¶ã€‚å¥½çš„ä»£ç è‡ªå·±ä¹Ÿä¸´æ‘¹äº†ä¸€ä¸‹ï¼Œä»¥åšçºªå¿µã€‚
1ã€åˆ›å»ºä¸¤ä¸ªå†…è”å‡½æ•°ç”¨äºè¿”å›ä¸åŒä¼˜å…ˆçº§çš„çŠ¶æ€ä»¥åŠä¸€ä¸ªç»“æ„ä½“ç”¨äºå­˜å‚¨ä¸åŒä¼˜å…ˆçº§ä¸‹çš„é˜Ÿåˆ—æ± ï¼Œä»¥åŠç›¸å…³ä¿¡æ¯
```
//ä¹Ÿå°±æ˜¯è¯´å»ºè®®ç¼–è¯‘å™¨å°†æŒ‡å®šçš„å‡½æ•°ä½“æ’å…¥å¹¶å–ä»£æ¯ä¸€å¤„è°ƒç”¨è¯¥å‡½æ•°çš„åœ°æ–¹ï¼ˆä¸Šä¸‹æ–‡ï¼‰ï¼Œä»è€ŒèŠ‚çœäº†æ¯æ¬¡è°ƒç”¨å‡½æ•°å¸¦æ¥çš„é¢å¤–æ—¶é—´å¼€æ”¯
static inline dispatch_queue_priority_t NSQualityOfServiceToDispatchPriority(NSQualityOfService qos){//<ios8
switch (qos) {
      case NSQualityOfServiceUserInteractive:
      return DISPATCH_QUEUE_PRIORITY_HIGH;
      case NSQualityOfServiceUserInitiated:
      return DISPATCH_QUEUE_PRIORITY_HIGH;
      case NSQualityOfServiceUtility:
      return DISPATCH_QUEUE_PRIORITY_LOW;
      case NSQualityOfServiceBackground:
      return DISPATCH_QUEUE_PRIORITY_BACKGROUND;
      case NSQualityOfServiceDefault:
      return DISPATCH_QUEUE_PRIORITY_DEFAULT;
      default:
      return DISPATCH_QUEUE_PRIORITY_DEFAULT;
    } 
}
static inline dispatch_qos_class_t NSQualityOfServiceToQOSClass(NSQualityOfService qos){//>ios8 å…¶ç›®çš„ç›¸åŒéƒ½æ˜¯ä¸ºäº†è®¾ç½®ç»™é˜Ÿåˆ—è®¾ç½®ä¸åŒçš„ä¼˜å…ˆçº§ã€‚
switch (qos) {
      case NSQualityOfServiceUserInteractive:
      return QOS_CLASS_USER_INTERACTIVE;
      case NSQualityOfServiceUserInitiated:
      return QOS_CLASS_USER_INITIATED;
      case NSQualityOfServiceUtility:
      return QOS_CLASS_UTILITY;
      case NSQualityOfServiceBackground:
      return QOS_CLASS_BACKGROUND;
      case NSQualityOfServiceDefault:
      return QOS_CLASS_DEFAULT;
      default:
      return QOS_CLASS_DEFAULT;
    }
}

```
```
typedef struct  {
     int countCount;//é˜Ÿåˆ—æ•°é‡
     atomic_int counter;//åŸå­è®¡æ•°å™¨ï¼Œç”¨æ¥è®°å½•æ˜¯ç¬¬å‡ æ¬¡å–é˜Ÿåˆ—
     void* *queues;//é˜Ÿåˆ—æ•°ç»„
     char* name;//context name
}LHDispatchContext;
```
2ã€å–é˜Ÿåˆ—æ–¹æ³• å…¶ä¸­æˆ‘æŠŠåŸå­è®¡æ•°æ–¹æ³•æ›¿æ¢æˆäº† atomic_fetch_add_explicitï¼Œè‹¹æœiOS10åç”¨æ­¤æ–¹æ³•ä»£æ›¿OSAtomicIncrement32
```
static dispatch_queue_t LHDispatchQueueGetFromContex(LHDispatchContext*contex){
      atomic_fetch_add_explicit(&contex->counter,1,memory_order_relaxed);//åŸå­ç´¯åŠ è®¡æ•°ï¼Œç”¨äºè®°å½•æ­¤æ–¹æ³•è¢«è®¿é—®æ¬¡æ•°
      int a =contex->counter%contex->countCount;//å–ä½™ï¼Œä¸ºçš„æ˜¯æŒ‰é¡ºåºå–é˜Ÿåˆ—ï¼Œå› ä¸ºé˜Ÿåˆ—æ˜¯ä¸²è¡Œï¼Œè¿™æ ·åšçš„è¯æé«˜æ•ˆç‡ã€‚
      return(__bridge dispatch_queue_t) contex->queues[a];
}
```
3ã€é˜Ÿåˆ—åˆ›å»ºæ–¹æ³•çš„å®ç°ã€‚NSQualityOfServiceToQOSClassã€NSQualityOfServiceToDispatchPriority ä¸¤ä¸ªå‡½æ•° ä½œè€…æ˜¯ç”¨å†…è”å‡½æ•°å®ç°ã€‚æé«˜æ•ˆç‡ã€‚ç”¨äºè¿”å›ä¼˜å…ˆçº§ã€‚
```
static LHDispatchContext* LHDispatchCreatQueue(char*name,int quneCount,NSQualityOfService qos){
      LHDispatchContext*contex =calloc(1, sizeof(LHDispatchContext));
      contex->countCount=quneCount;
      contex->name =name;
      if (!contex) {
        return NULL;
      }
     contex->queues=calloc(quneCount, sizeof(void*));
     if (!contex->queues) {
     free(contex);
     }
     if ([UIDevice currentDevice].systemVersion.floatValue>8.0) {
     dispatch_qos_class_t qos_class = NSQualityOfServiceToQOSClass(qos);
     dispatch_queue_attr_t att = dispatch_queue_attr_make_with_qos_class(DISPATCH_QUEUE_SERIAL, qos_class, 0);
     for (int i=0; i<quneCount; i++) {
     dispatch_queue_t q = dispatch_queue_create(name, att);
     contex->queues[i]=(__bridge_retained  void*)q;
     }

     }else{
      for (int i=0; i<quneCount; i++) {
      long identifier = NSQualityOfServiceToDispatchPriority(qos);
      dispatch_queue_t q =  dispatch_queue_create(name, DISPATCH_QUEUE_SERIAL);
      dispatch_set_target_queue(q, dispatch_get_global_queue(identifier, 0));
      contex->queues[i] =(__bridge_retained void*)q;
    }

}

return contex;
}
```
4ã€æ ¹æ®ä¸åŒçš„ä¼˜å…ˆçº§åˆ›å»ºé˜Ÿåˆ—ç»„ã€‚å…¶ä¸­ç”¨åˆ°äº†å•ä¾‹æ¨¡å¼ï¼Œå®ç°å…¨å±€çš„è·å–ï¼Œé¿å…å¤šæ¬¡åˆ›å»ºã€‚
```
static LHDispatchContext* LHDispatchGetContexforQos(NSQualityOfService qos){
     static LHDispatchContext* contexArr[5]={0};//åˆ›å»ºä¸€ä¸ªLHDispatchContextæ•°ç»„ç”¨ä¸å­˜å‚¨ä¸åŒä¼˜å…ˆçº§ä¸‹çš„contexã€‚
     switch (qos) {
     case NSQualityOfServiceUserInteractive:{
     static dispatch_once_t onceToken;
     dispatch_once(&onceToken, ^{
     int count = (int)[NSProcessInfo processInfo].activeProcessorCount;
     count = count<1?1:count>MaxQueueCount?MaxQueueCount:count;
     contexArr[0] = LHDispatchCreatQueue("com.lh.pool-user-Interactive", count, qos);
     });
     return contexArr[0];
     }break;

     case NSQualityOfServiceUserInitiated: {
     static dispatch_once_t onceToken;
     dispatch_once(&onceToken, ^{
     int count = (int)[NSProcessInfo processInfo].activeProcessorCount;
     count = count<1?1:count>MaxQueueCount?MaxQueueCount:count;//å–å½“å‰æ´»è·ƒçš„è¿›ç¨‹æ•°ï¼Œåˆ›å»ºä¸²è¡Œé˜Ÿåˆ—æ•°ç»„ï¼Œä»¥è¾¾åˆ°èµ„æºçš„åˆç†åˆ©ç”¨ã€‚
     contexArr[1] = LHDispatchCreatQueue("com.lh.pool-user-Initiated", count, qos);
     });
     return contexArr[1];
     break;
     }
     case NSQualityOfServiceUtility: {
     static dispatch_once_t onceToken;
     dispatch_once(&onceToken, ^{
     int count = (int)[NSProcessInfo processInfo].activeProcessorCount;
     count = count<1?1:count>MaxQueueCount?MaxQueueCount:count;
     contexArr[2] = LHDispatchCreatQueue("com.lh.pool-user-Utility", count, qos);
     });
     return contexArr[2];
     break;
     }
     case NSQualityOfServiceBackground: {
     static dispatch_once_t onceToken;
     dispatch_once(&onceToken, ^{
     int count = (int)[NSProcessInfo processInfo].activeProcessorCount;
     count = count<1?1:count>MaxQueueCount?MaxQueueCount:count;
     contexArr[3] = LHDispatchCreatQueue("com.lh.pool-user-Background", count, qos);
     });
     return contexArr[3];
     break;
     }
case NSQualityOfServiceDefault: {
     static dispatch_once_t onceToken;
     dispatch_once(&onceToken, ^{
     int count = (int)[NSProcessInfo processInfo].activeProcessorCount;
     count = count<1?1:count>MaxQueueCount?MaxQueueCount:count;
     contexArr[4] = LHDispatchCreatQueue("com.lh.pool-user-Default", count, qos);
     });
     return contexArr[4];
     break;
    }
  }
  return NULL;
}
```
æœ€åæ€»ç»“ï¼š
* YYLabel å¯ä»¥ç”¨æ¥å®ç°å¼‚æ­¥æ¸²æŸ“ã€‚
* å½“æ”¹å˜äº† Frameã€æ›´æ–°äº† UIView/CALayer çš„å±‚æ¬¡æ—¶ï¼Œæˆ–è€…æ‰‹åŠ¨è°ƒç”¨äº† UIView/CALayer çš„ setNeedsLayout/setNeedsDisplayæ–¹æ³•åï¼Œè¿™ä¸ª UIView/CALayer å°±è¢«æ ‡è®°ä¸ºå¾…å¤„ç†ï¼Œå¹¶è¢«æäº¤åˆ°ä¸€ä¸ªå…¨å±€çš„å®¹å™¨å»
* ç”±äºrunloopä¼šåœ¨å³å°†è¿›å…¥ä¼‘çœ æˆ–è€…é€€å‡ºæ—¶å¤„ç†æ‰€æœ‰è¢«æ ‡è®°è¿‡çš„UIView/CALayerï¼Œé€šè¿‡è°ƒç”¨drawrect/displayå®Œæˆæ¸²æŸ“ã€‚
* Nä¸ªä¸²è¡Œé˜Ÿåˆ—ç›¸å½“äºNä¸ªä¸€æ¡ç”Ÿäº§çº¿çš„æ¸²æŸ“å·¥å‚ï¼Œæˆ‘æŒ‰é¡ºåºæŠŠä»»åŠ¡åˆ†é…ç»™å„ä¸ªå·¥å‚ï¼Œéå¸¸äº•äº•æœ‰æ¡çš„ä¸€ç§ç”Ÿäº§åˆ†é…æ–¹å¼ğŸ˜„ã€‚
